# 트랜잭션

- DBMS가 데이터베이스를 다룰 때 사용하는 작업 단위
- 무결성을 유지하기 위해 원자성, 일관성, 고립성, 지속성의 성질을 갖는다

### 개념

- 장애 발생 시 데이터를 복구하는 작업의 단위
- 작업을 서로 분리하는 단위

1. all or nothing : 트랜잭션은 전체가 수행되거나 전혀 수행되지 않아야 한다
2. 데이터 처리를 위해서 주기억장치 버퍼로 사본을 읽어와야한다

   - 데이터베이스에 저장된 테이블을 읽어와 주기억장치 버퍼에 저장 -> 수정 -> 다시 데이터베이스에 저장

### 성질

- 원자성 : all or nothing
  - 트랜잭션의 길이가 길면 중간 지점에 수정내용을 반영하는 SAVEPOINT를 만든다
- 일관성 : 수행 전이나 후나 데이터베이스는 항상 일관된 상태를 유지
  - 일관성 유지를 위해 무결성 제약조건을 활용 -> 동시성 제어 알고리즘 작동이 필요함
- 고립성 : 수행 중인 트랜잭션에 끼어들 수 없다
  - 동시성 제어 : 트랜잭션이 같은 데이터를 가지고 충돌하지 않도록 제어
- 지속성 : 완료한 트랜잭션은 변경한 데이터를 영구히 저장
  - DBMS 복구 시스템은 트랜잭션 작업 내용을 수시로 log데이터베이스에 기록한다 (시스템이 멈추어도 트랜잭션 수행내용은 디스크에 기록됨)
  - 회복 관리자 프로그램을 이용하여 로그 기록을 함

# 동시성 제어

- 트랜잭션을 동시에 수행해도 일관성이 훼손되지 않도록 데이터 접근을 제어하는 DBMS 기능

## 락

- 자신이 데이터를 수정 중이라는 사실을 알리는(잠그는) 기능
- 응답시간에 영향을 주기에 가능한 최소화 해야 함

공유락(LS)

- 읽기를 할 때 사용하는 락

배타락(LX)

- 읽기/쓰기를 할 때 사용하는 락

## 2단계 락

- 락을 걸었다 풀고 다시 거는 과정에서의 중간 결과가 보여지는 것을 방지하기 위한 기법

### 확장단계

- 트랜잭션이 필요한 락을 획득하는 단계, 이미 획득한 락을 해제하지 않는다

### 수축단계

- 락을 해제하는 단계, 새로운 락을 획득하지 않는다

## 데드락(교착상태)

- 두 개 이상의 트랜잭션이 서로에게 락을 요청하여 무한 대기 상태에 빠진 경우
- DBMS는 하나를 강제로 중지 시킴으로써 해결한다

# 트랜잭션 고립 수준

### 오손 읽기

- 읽기만 하는 트랜잭션이 쓰기 트랜잭션에서 작업한 중간 데이터를 읽을 때 발생하는 문제
- 쓰기 트랜잭션이 철회(ROLLBACK)할 경우 문제가 생긴다

### 반복불가능 읽기

- 읽기 트랜잭션이 읽은 후에 쓴 데이터를 읽기 트랜잭션이 다시 한번 데이터를 읽을 때 생기는 문제. 이전의 결과가 반복되진 않는 현상이다

### 유령데이터 읽기

- 반복불가능 읽기와 비슷한 경우로 이전에 없던 데이터가 나타나는 현상. 읽기 트랜잭션이 새로운 데이터를 삽입한 사실을 모르고 작업할 경우 생기는 문제

## 트랜잭션 고립 수준 명령어

- 사용자가 선택하여 트랜잭션을 제어

### READ UNCOMMITTED(LV.0)

- 자신의 데이터에 아무런 공유락을 걸지 않는다
- 공유락과 배타락을 대기하지 않고 읽는다
- COMMIT하지 않은 데이터도 읽을 수 있다

### READ COMMITTED(LV.1)

- 데이터를 읽는 동안 공유락을 걸지만 트랜잭션이 끝나기 전에라도 해지가능

### REPEATABLE READ(LV.2)

- 공유락과 배타락을 트랜잭션 종료할 때까지 유지, 다른 트랜잭션이 자신의 데이터를 UPDATE할 수 없게 함

### SERIALIZABLE(LV.3)

- 실행 중인 트랜잭션은 다른 트랜잭션으로부터 완벽하게 분리
- 데이터 집합에 범위를 지어 잠금 설정 가능

# 회복

- 데이터베이스를 일관성 있는 상태로 되돌리는 DBMS의 기능

## 장애 유형

### 시스템 충돌

- 소프트웨어의 오류로 주기억장치가 손실

### 미디어 장애

- 헤드 충돌이나 읽기 장애로 보조기억장치가 손실

### 응용 소프트웨어 오류

- 데이터베이스에 접근하는 소프트웨어의 논리적인 오류로 트랜잭션의 수행이 실패하는 경우

# 회복 관리자

- DBMS의 회복 관리자는 원자성과 지속성을 보장하여 데이터베이스를 보호
- 트랜잭션의 변경 내용을 로그에 기록한 후 데이터베이스에 반영한다
- 로그파일의 로그를 참조하여 원자성을 보장한다

# 로그파일을 이용한 회복

- READ는 로그에 기록되지 않는다
- 종료된 트랜잭션은 종료를 확정하기 위해 재실행(REDO)
  - 로그를 통해 트랜잭션이 변경한 내용을 데이터 베이스에 다시 기록하는 과정
- 중단된 트랜잭션은 없던일로 하기 위해 취소(UNDO)
  - 로그에 COMMIT이 없는 경우
  - 트랜잭션이 변경한 내용을 없던일로 하기 위해 데이터베이스에서 원상복구 시킨다

### 즉시 갱신

- 부분 완료전에 작업이 동시에 진행 가능하고 버퍼의 내용의 일부가 실제 데이터베이스에 반영될 수 있다

### 지연갱신

- 버퍼 - 로그 의 작업이 끝난 후 부분완료를 하고 버퍼 - 데이터베이스 작업을 진행한다

# 체크 포인트

- 로그는 어느 시점까지 돌아가야 하는지 알 수 없음
- 몇 십분 단위로 데이터와 트랜잭션 로그 파일을 동기화한 후 동기화한 시점을 로그파일에 기록하는 방법
