# Ch8 트랜잭션, 동시성 제어, 회복

## 1️⃣ 트랜잭션

- DBMS에서 데이터를 다루는 논리적인 작업의 단위.
    - 장애 발생시 데이터를 복구하는 작업의 단위
    - 여러 작업이 동시에 같은 데이터를 다룰 때, 이 작업을 서로 분리하는 단위
- 작동 원리 : 데이터베이스에 저장된 테이블을 읽어와 주기억장치 버퍼에 저장 → 버퍼에 저장된 데이터를 수정 → 데이터베이스에 다시 저장
- COMMIT : 트랜잭션의 종료를 알리는 SQL문.
    - 트랜잭션은 임시로 종료를 선언하고 실제 데이터베이스에 기록하는 것은 DBMS가 진행한다 .
    - 수행결과를 데이터베이스에 기록하는 과정이 시간이 많이 소요되고, 다른 트랜잭션이 또 Customer 테이블을 필요로 할 수 있기 때문이다.
    - 시작 - 수행 - 부분완료 - 버퍼내용 기록 - 완료(COMMIT)
- 트랜잭션의 성질(ACID)
    - 원자성 (Atomicity) : 트랜잭션에 포함된 작업은 전부 수행되거나 아니면 전부 수행되지 않아야 한다.
    - 일관성 (Consistency) : 트랜잭션을 수행하기 전이나 수행한 후나 데이터베이스는 항상 일관된 상태를 유지해야 한다.
    - 고립성 (Isolation) : 수행 중인 트랜잭션에 다른 트랜잭션이 끼어들어 변경 중인 데이터 값을 훼손하는 일이 없어야 한다.
    - 지속성 (Durability) : 수행을 성공적으로 완료한 트랜잭션은 변경한 데이터를 영구히 저장해야 한다.
        - 부분완료 : 트랜잭션 수행은 완료되었지만 변경 내용이 데이터베이스에 기록되었는지 확실하지 않은 상태
        - 실패 : 트랜잭션을 중강네 중단하였거나 부분완료 상태에서 변경 내용을 데이터베이스에 저장하지 못한 상태
- 트랜잭션과 DBMS : DBMS는 트랜잭션이 원자성, 일관성, 고립성, 지속성을 유지할 수 있도록 지원함.
    - DBMS는 일관성을 유지하기 위해 무결성 제약조건을 활용.
    - DBMS는 고립성을 유지하기 위해 일관성을 유지하는 것과 마찬가지로 동시성 제어 알고리즘을 작동 시킴.
    - DBMS는 지속성을 유지하기 위해 회복 관리자 프로그램을 이용.

## 2️⃣ 동시성 제어(Concurrency control)

- 많은 트랜잭션이 동시에 수행될때, 일관성을 해치지 않도록 트랜잭션의 데이터 접근을 제어하는 DBMS의 기능.
- 갱신손실(lost update) 문제 : 두 개의 트랜잭션이 한 개의 데이터(공유 데이터)를 동시에 갱신할 때 발생하는 현상.
    - 해결책으로 자신이 데이터를 수정 중이라는 사실을 알리면 되는데, 이때 사용하는 방법으로 락이라는 잠금장치를 사용한다.
- 락(Lock) : 트랜잭션이 데이터를 읽거나 수정할 때 데이터에 표시하는 잠금 장치.
    - 트랜잭션이 다루는 데이터를 다른 트랜잭션이 접근하지 못하도록 막아 대기상태로 만든다.
    - 데이터에 락이 걸려있지 않으면 트랜잭션은 데이터에 락을 걸 수 있다.
    - 공유락(LS, shared lock) : 읽기를 할 때 사용하는 락
    - 배타락(LX, exclusive lock) : 읽기/쓰기를 할 때 사용하는 락
    - 공유락은 상호 허용되지만 배타락은 허용되지 않는다.
        
        
        |  | LS 상태 | LX 상태 |
        | --- | --- | --- |
        | LS 요청 | 허용 | 대기 |
        | LX 요청 | 대기 | 대기 |
- 락킹(2 phase locking) : 락을 걸고 푸는 과정에서 락의 해지 상태가 생기면서 다른 트랜잭션에 중간 결과를 보여주는 상황이 생기는데, 이런 상황을 방지하기 위해 락킹 기법을 사용한다.
    - 확장 단계(Growing phase, Expanding phase) : 트랜잭션이 필요한 락을 획득하는 단계
    - 수축 단계(Shrinking phase) :  트랜잭션이 락을 해제하는 단계
    - deadlock : 자신의 데이터에 대하여 락을 획득하고 상대방 데이터에 대하여 락을 요청하여 무한 대기에 빠지는 상태.

## 3️⃣ 트랜잭션 고립 수준

- 트랜잭션 동시 실행 문제 : 읽기만 하는 트랜잭션이 쓰기 트랜잭션에서 작업한 중간 데이터를 읽기 때문에 발생하는 문제들
    - 오손 읽기(dirty read) 문제 : 읽기 작업을 하는 트랜잭션A가 쓰기 작업을 하는 트랜잭션B가 작업한 중간 데이터를 읽기 때문에 생기는 문제
    - 반복불가능 읽기(non- repeatable read) 문제 : 트랜잭션A가 읽기 작업을 다시 한 번 반복할 경우 **이전의 결과가 반복되지 않는 현상**
    - 유령 데이터 읽기(phantom read) 문제 : 트랜잭션A가 읽기 작업을 다시 한 번 반복할 경우 이전에 **없던 데이터가 나타나는 현상**
- 트랜잭션 고립 수준 명령어
    - READ UNCOMMITTED
        
        
        | 모드 | READ UNCOMMITTED  |
        | --- | --- |
        | LOCK | SELECT 문 - 공유락 걸지 않음
        UPDATE 문 - 배타락 설정
        다른 트랜잭션의 공유락과 배타락이 걸린 데이터를 읽음 |
        | SQL 문 | SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED |
        | 문제점 | dirty read, non-repeatable read, phantom read |
    - READ COMMITTED
        
        
        | 모드  | READ COMMITTED |
        | --- | --- |
        | LOCK | SELECT 문 - 공유락 걸고 끝나면 바로 해지
        UPDATE 문 - 배타락 설정
        다른 트랜잭션이 설정한 공유락은 읽지만 배타락은 읽지 못함 |
        | SQL 문 | SET TRANSACTION ISOLATION LEVEL READ COMMITTED |
        | 문제점 | non-repeatable read, phantom read |
    - REPEATABLE READ : 데이터 동시성이 낮아 특별한 상황이 아니면 권하지 않음.
        
        
        | 모드 | REPEATABLE READ |
        | --- | --- |
        | LOCK | SELECT 문 - 공유락 걸고 트랜잭션 끝까지 유지
        UPDATE 문 - 배타락 설정
        다른 트랜잭션이 설정한 공유락은 읽지만 배타락은 읽지 못함 |
        | SQL 문 | SET TRANSACTION ISOLATION LEVEL REPEATABLE READ |
        | 문제점 | phantom read |
    - SERIALIZABLE : 데이터 동시성도 낮고 고립 수준이 가장 높은 명령어.
        
        
        | 모드 | SERIALIZABLE |
        | --- | --- |
        | LOCK | SELECT 문 - 공유락 걸고 트랜잭션 끝까지 유지
        UPDATE 문 - 배타락 설정
        다른 트랜잭션이 설정한 공유락은 읽지만 배타락은 읽지 못함
        인덱스에 공유락을 설정하여 다른 트랜잭션의 INSERT 문이 금지됨. |
        | SQL 문 | SET TRANSACTION ISOLATION LEVEL SERIALIZABLE |
        | 문제점 | X |

## 4️⃣ 회복

- 데이터베이스에 장애가 발생했을 때 데이터베이스를 일관성 있는 상태로 되돌리는 DBMS 기능
    - 시스템 충돌 : 하드웨어 혹은 소프트웨어의 오류로 주기억장치가 손실되는 것
    - 미디어 장애 : 헤드 충돌이나 읽기 장애로 보조기억장치가 손실되는것
    - 응용 소프트웨어 오류 : 데이터베이스에 접근하는 소프트웨어의 논리적인 오류로 트랜잭션의 수행이 실패하는것
- 트랜잭션과 회복
    - 트랜잭션은 데이터베이스 회복의 단위.
    - DBMS의 회복 관리자는 트랜잭션의 ACID 성질 중 원자성과 지속성을 보장하여 장애로부터 데이터베이스를 보호.
- 로그 : DBMS가 트랜잭션이 수행중이거나 수행이 종료된 후 발생하는 데이터베이스 손실을 방지하기 위해 트랜잭션의 데이터베이스 기록을 추적하는 로그 파일을 사용.
    - 트랜잭션이 반영한 모든 데이터의 변경사항을 데이터베이스에 기록하기 전에 미리 기록해두는 별도의 데이터베이스.
    - 하드디스크에 저장되며 전원과 관계없이 기록이 남아있다.
    - <트랜잭션번호, 로그 타입, 데이터 항목 이름, 수정 전 값, 수정 후 값>