# 트랜잭션,동시성 제어, 회복

# 1. 트랜잭션

1-1 개념

: 데이터 베이스를 다룰 때 사용하는 작업(프로그램) 단위이다.

### 1-2 DB에서 트랜잭션을 정의하는 이유

- DB에서 데이터를 다룰 때 **장애가 발생 할 시**, 트랜잭션은 **데이터를 복구하는 작업의 단위**
- DB에서 **여러 작업이 동시에 같은 데이터를 다룰 때**, **트랜잭션은 서로 분리하는 단위.**

## 1-3 특징

- 일반적으로는 단일 SQL 문을 사용하여 다룸, 하지만 여러 개의 SQL 문을 순차적으로 수행하여 다루기도 한다.
- 트랜잭션은 전체가 수행되거나 또는 수행되지 않아야 한다.(**원자성**)

## 1-4 성질

- **원자성**

  : 트랜잭션에 포함된 작업은 전부 수행되거나 아니면 전부 수행되지 않아야 한다.

- **일관성**

  : 트랜잭션을 수행하기 전이나 수행한 후나 DB는 항상 일관된 상태를 유지해야 한다.

- **고립성**

  : 수행 중인 트랜잭션에 다른 트랜잭션이 끼어들어 변경 중인 데이터 값을 훼손하는 일이 없어야 한다.

- **지속성**

  : 수행을 성공적으로 완료한 트랜잭션은 변경한 데이터를 영구히 저장해야 한다. 저장된 DB는 저장 직후 혹은 어느 때나 발생할 수 있는 정전, 장애, 오류에 영향을 받지 않아야 한다.


## 1-5 트랜잭션과 DBMS

- DBMS는 트랜잭션의 성질들이 유지할 수 있도록 지원한다.
- DBMS는 일관성을 유지하기 위해 무결성 제약 조건을 활용한다.
- DBMS는 고립성을 유지하기 위해 일관성을 유지하는 것과 마찬가지로 동시성 제어 알고리즘을 작동 시킨다.
- DBMS는 지속성을 유지하기 위해 회복 관리자 프로그램을 이용한다.

# 2. 동시성 제어

2-1 개념

: 트랜잭션이 동시에 수행 될 때, **일관성을 해치지 않도록 트랜잭션의 데이터 접근을 제어하는 DBMS 기능**

2-2 갱신손실 문제

: 두 개의 트랜잭션이 한 개의 데이터를 동시에 갱신할 때 발생한다.

### 갱신손실 문제는 데이터 베이스에서 절대 발생하면 안 되는 현상.

2-3 락

: 트랜잭션이 데이터를 읽거나 수정할 때 **데이터에 표시하는 잠금 장치이다**.

Ex) 트랜잭션 T1, T2가 있다고 하자.

**T1이 버퍼 데이터 값인 X에 락을 걸었다면, T2는 대기(wait)한다.**

**T2는 T1이 언락해야지 진행할 수 있다.**

### 2-4 락의 유형

**LS(공유 락)** : **트랜잭션이 읽기를 할 때** 사용하는 락.

**LX(배타 락)** : **트랜잭션이 읽기/쓰기를 할 때** 사용하는 락.

### 2-5 규칙

- **데이터에 락이 걸려있지 않으면**, 트랜잭션은 데이터에 **락을 걸 수 있다.**
- **트랜잭션이 데이터 X를 읽기만 할 경우 LS(X)를 요청**하고,  **읽거나 쓰기를 할 경우 LX를 요청**한다.
- 다른 트랜잭션이 데이터에 **LS를 걸어두면**, **LS의 요청은 허용**하고 **LX는 허용하지 않는다**.
- 다른 트랜잭션이 데이터에 **LX을 걸어두면**, **LS,LX 모두 허용하지 않는다.**
- 트랜잭션이 **락을 허용받지 못하면 대기 상태**가 된다.

### 2-6 2단계 락킹

- **확장 단계**: 트랜잭션이 필요한 **락을 획득하는 단계**, 이 단계에서 **이미 획득한 락을 해체하지 않는다**.
- **수축 단계**: 트랜잭션이 **락을 해체하는 단계**, 이 단계에서는 **새로운 락을 획득하지 않는다**.

# 3. 트랜잭션 고립 수준

## 3-1 트랜잭션 동시 실행 문제

3-1-1 오손 읽기

: 트랜잭션 1이 쓰기 작업을 하는 트랜잭션 2가 **작업한 중간 데이터를 읽기 때문에 생기는 문제.**



3-1-2 반복불가능 읽기

: 트랜잭션 1이 데이터를 읽고 트랜잭션 2가 데이터를 쓰고(**UPDATE**), **트랜잭션 1이 다시 한 번 데이터를 읽을 때 생기는 문제.**

3-1-3 유령데이터 읽기

: 트랜잭션 1이 데이터를 읽고 트랜잭션 2가 데이터를 쓰고(**INSERT**), **트랜잭션 1이 다시 한 번 데이터를 읽을 때 생기는 문제.**

## 3-2 트랜잭션 고립 수준 명령어

3-2-1 개념

: DBMS는 트랜잭션을 동시에 실행시키면서 **락보다 좀 더 완화된 방법으로 문제를 해결하는 명령어**.

### 3-2-2 트랜잭션 고립 수준 TLFTMQ

| 문제 발생 | 문제 방지 |
| --- | --- |
| 반복 불가능 읽기 | REPEATABLE READ MODE |
| 유령 데이터 읽기 | SERIALIZABLE MODE |

# 4. 회복

개념

: DB에 장애가 발생했을 때 **DB를 일관성 있는 상태로 되돌리는 DBMS의 기능이다.**

## 4-1 트랜잭션과 회복

- 트랜잭션은 **DB 회복의 단위이다.**
- 트랜잭션은 **데이터 변경 내용을 한 순간에 모두 DB에 기록하지 않고,** 변경 내용(버퍼)을 로그(임시 디스크)에 기록한 후 **데이터베이스에 반영한다.**
- DBMS의 **회복 관리자는 트랜잭션의 ACID 설질 중 원자성, 지속성을 보장해 DB를 보호함.**

4-2 로그파일

: DBMS는 트랜잭션이 수행 중이거나 수행이 종료된 후 발생하는 **데이터베이스 손실을 방지하기 위해 데이터베이스 기록을 추적하는 파일.**

**저장 형태**

**<트랜잭션번호, 로그 타입(연산 타입), 데이터 항목 이름, 수정 전 값, 수정 후 값>**

## 4-3 로그 파일을 이용한 회복

- **재실행(REDO):** 기록된 로그를 이용해, **트랜잭션이 수행한 결과를 다시 반영하는 연산.**
- **취소(UNDO):** 기록된 로그를 이용해, **수행한 결과를 취소하는 연산.**

4-4 체크 포인트

: 데이터베이스와 트랙잭션 **로그 파일을 동기화 후**, 동기화한 시점을 **로그 파일에 기록하는 것을 말함**.